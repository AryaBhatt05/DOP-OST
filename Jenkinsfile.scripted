node {
  def mvnHome = tool name: 'M3', type: 'hudson.tasks.Maven$MavenInstallation'
  def jdkHome = tool name: 'JDK17', type: 'hudson.model.JDK'

  withEnv(["JAVA_HOME=${jdkHome}", "PATH+JAVA=${jdkHome}/bin", "PATH+MAVEN=${mvnHome}/bin"]) {
    stage('Checkout') {
      checkout scm
    }
    stage('Build') {
      sh 'mvn -v'
      sh 'mvn -B -DskipTests=true clean package'
      archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
    }
    stage('Test') {
      sh 'mvn -B test'
      junit 'target/surefire-reports/*.xml'
    }
  }
}